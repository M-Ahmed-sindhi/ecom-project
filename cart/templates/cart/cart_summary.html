{% extends 'base.html' %}

{% block content %}
<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Shopping Cart</h1>
      <p class="lead fw-normal text-white-50 mb-0">View Your Cart...</p>
    </div>
  </div>
</header>

<div class="container mt-4">
  {% if cart_products %}
    {% for product in cart_products %}
      <div class="card mb-3">
        <div class="row g-0">
          <div class="col-md-4">
            <img src="{{ product.image }}" class="img-fluid rounded-start" alt="{{ product.name }}">
          </div>
          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="card-text">{{ product.description }}</p>
              <p class="card-text">
                <small class="text-body-secondary">Last updated 3 mins ago</small>
              </p>

              <div class="row align-items-center mt-3">
                <div class="col-md-3">
                  <label class="form-label">Quantity:</label>
                </div>
                <div class="col-md-3">
                  <select class="form-select" id="select{{ product.id }}" name="quantity">
                    <option selected>
                      {% for key, value in cart_quantity.items %}
                        {% if key == product.id|stringformat:"s" %}
                          {{ value }}
                        {% endif %}
                      {% endfor %}
                    </option>
                    {% for i in "12345" %}
                      <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="mt-3">
                {% if product.is_sale %}
                  <span class="text-muted text-decoration-line-through">{{ product.price }}</span>
                  <p>{{ product.sale_price }}</p>
                {% else %}
                  <p class="card-text">{{ product.price }}</p>
                  <p>ID: {{ product.id }}</p>
                {% endif %}
              </div>

              <div class="mt-3">
                <button class="btn btn-primary update-cart" data-product-id="{{ product.id }}">
                  Update Cart
                </button>
                <button class="btn btn-danger delete-product" data-product-id="{{ product.id }}">
                  Remove
                </button>

              </div>

            </div>

            
          </div>
        </div>
      </div>
    {% endfor %}


    <h3>total : ${{totals}}</h3>
    <a href="{% url 'checkout' %}" class="btn btn-success align-left">
      Checkout
  </a>
   
  {% else %}
    <div class="text-center mt-5">
      <p>Your cart is empty</p>
    </div>
  {% endif %}
</div>




<script>
  $(document).on('click', '.update-cart, .delete-product', function (e) {
    e.preventDefault();

    const $button = $(this);
    const productId = $button.data('product-id');
    const quantity = $('#select' + productId).val();
    const isDelete = $button.hasClass('delete-product');
    const url = isDelete ? '{% url "cart-delete" %}' : '{% url "cart-update" %}';

    $.ajax({
      type: 'POST',
      url: url,
      data: {
        product_id: productId,
        quantity: quantity,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function (response) {
        console.log('Success:', response);
        if (response.success) {
          location.reload();
        } else {
          alert('Error: ' + (response.error || 'Unknown error'));
        }
      },
      error: function (xhr) {
        console.log('XHR response:', xhr.responseText);
        alert('An error occurred while updating the cart. Please try again.');
      }
    });
  });
</script>
{% endblock %}

